---
title: "Historial extract from iworkforsa - lab book"
author: "ofchurches"
date: "28 June 2021"
output:
  github_document
always_allow_html: yes
---

# Background
This markdown is a preliminary investigation of the data provided by the [Office of the Commissioner for Public Sector Employment](https://www.publicsector.sa.gov.au/).The data contains details from every advertisment on [iworkforsa.gov.au](https://iworkfor.sa.gov.au/).

Note that these data have been classified as "Public" by the OCPSE.

## Packages

```{r warning=FALSE, message=FALSE}
library(readxl)
library(tidyverse)
library(here)
library(lubridate)
library(kableExtra)
library(naniar)
library(patchwork)
library(skimr)
```

## Import, arrange and format

```{r warning=FALSE, message=FALSE}
path <- here("IWORK4SA Data 2017-2021, Classification-Public.xlsx")

advertiments <- path %>% 
  excel_sheets() %>%
  map_dfr(
    function(sheet) {
      temp = read_excel(sheet, path = path, skip = 8)
      mutate(temp, Year = sheet)
    }
  )

```


## Checks and balances

### Check the top and bottom of the data

Data read in from `xlsx` files often has bits of extra information above *and* below the actual "data". To check that we haven't accidentaly imported that we can have a look at the top and bottom of our dataset.

```{r}
advertiments %>%
  slice_head(n = 3) %>%
  kable() %>%
  kable_styling()

advertiments %>%
  slice_tail(n = 3) %>%
  kable() %>%
  kable_styling()
```

It looks like we've imported some extra rows that we don't want because they were footer details and some `NA` whole rows. We can remove them.

```{r}
advertiments_clean <- advertiments%>%
  filter(str_detect(`Date Publish To Public Drill`, "Report created") == FALSE | is.na(`Date Publish To Public Drill`) == TRUE) %>%
  filter(is.na(`Position ID Job Title`) == FALSE)
```

Just to check this again. We imported five sheets from the `xlsx` file so `advertiments_clean` should now fave five less rows than `advertisments`. And, the difference in rows is: `r nrow(advertiments) - nrow(advertiments_clean)`!

### Change format

Let's put the variables in a format that we can treat appropriately.

```{r}
advertiments_formatted <- advertiments_clean %>% 
  mutate(`Date Publish To Public Drill` = ymd(`Date Publish To Public Drill`)) %>%
  mutate(`I Workfor SA Min Salary` = as.numeric(`I Workfor SA Min Salary`)) %>%
  mutate(`I Workfor SA Max Salary` = as.numeric(`I Workfor SA Max Salary`))
```

### What are we working with
It would be good to have a look at the data types in each variable to work out if its suitable for what we'll want to do in the analysis.

```{r}
advertiments_formatted %>%
  skim()
```


### Missing data

```{r, fig.align="center"}
advertiments_formatted %>%
  gg_miss_var(show_pct = TRUE, facet = Year) +
  labs(title = str_wrap("Percent of missing data for each variable in `advertisments`", width = 50))
```

It seems that all the variables except `I Workfor SA Part Time Hours` have minimal missing values and none of this changes much over time.

```{r, fig.align="center"}
gg_miss_upset(advertiments_formatted)
```

Its reasuring that `I Workfor SA Min Salary` and `I Workfor SA MAX Salary` are only missing in combination with each other (and sometimes with `I Workfor SA Part Time Hours` as well).

The only note that appears particularly pertinent from these analyses is that `I Workfor SA Part Time Hours` should be treated with caution. We should note that the variables: `Division`, `Position Status`, `Position ID`, `Position ID Job Title`, `I Workfor SA Part Time` and `Year` are all completed with no missing values.

# Analyses

## "Data" jobs

The motivation for getting these data that Owen and Tim talked about was to look at advertisments for "data" jobs to investigate questions such as:

* Are they increasing as a proportion of the advertisments?
* What departments are recruiting them?
* What sort of work are they being anticipated to do?

### Definition caveats

To answer this question we need a definition of "data" jobs.

We can do this by including words and word-parts that signify the sort of job we are interested in. It is worth stating up front that this is necessarily a decision process rather than a data process. That is, the jobs we end up with classified as "data" and "not data" will be so classified because of our subjective *decision* not because of some objective *data*. In addition, this has a signal detection characteristic in that sue to that application of a strict definition, there will be errors both due to some "not data" jobs which end up classified as "data jobs" and some "data jobs" that end up classified as "not data jobs".

### Definition

Regardless, we can set the definition and accept these caveats. Importantly, because the new variable `Defined as a data job` is based on `Position ID Job Title`, there will be no missing values in this new variable.

Data jobs will be defined as such:

```{r}
data_job_definitions <- c("data", "analyt", "information", "intelligence", "statistic")
```

Then we can append this definition to the dataframe:

```{r}
advertiments_defined <- advertiments_formatted %>% 
  mutate(`Defined as a data job` = ifelse(str_detect(str_to_lower(`Position ID Job Title`), 
                                                     paste(data_job_definitions, collapse = "|")
                                                     ), 
         "Data", "Not data"))
```


## Answers

### Are "data jobs" increasing as a proportion of the advertisments?


```{r, fig.align="center"}
count_plot <- advertiments_defined %>%
  group_by(`Defined as a data job`, Year) %>%
  count(name = "Number of advertisments") %>%
  ggplot(aes(x = Year, y = `Number of advertisments`, colour = `Defined as a data job`, group = `Defined as a data job`)) + 
  geom_line() + 
  scale_y_log10() + 
  labs(title = "Count of jobs on iworkforsa that  each year by definition")

percent_plot <- advertiments_defined %>%
  group_by(`Defined as a data job`, Year) %>%
  count() %>%
  group_by(Year) %>%
  mutate(`Percentage within each year`= n/sum(n)) %>%
  ggplot(aes(x = Year, y = `Percentage within each year`, colour = `Defined as a data job`, group = `Defined as a data job`)) + 
  geom_line() + 
  scale_y_log10() + 
  labs(title = "Percentage of jobs on iworkforsa each year by definition")

count_plot/percent_plot
```

