---
title: "Historical extract from iworkforsa - lab book"
author: "ofchurches"
date: "28 June 2021"
output:
  github_document
always_allow_html: yes
---

# Background
This markdown is a preliminary investigation of the data provided by the [Office of the Commissioner for Public Sector Employment](https://www.publicsector.sa.gov.au/).The data contains details from every advertisement on [iworkforsa.gov.au](https://iworkfor.sa.gov.au/).

Note that these data have been classified as "Public" by the OCPSE.

## Packages

```{r warning=FALSE, message=FALSE}
library(readxl)
library(tidyverse)
library(here)
library(lubridate)
library(kableExtra)
library(naniar)
library(patchwork)
library(skimr)
library(DT)
library(ComplexUpset)
```

## Import, arrange and format

```{r warning=FALSE, message=FALSE}
path <- here("IWORK4SA Data 2017-2021, Classification-Public.xlsx")

advertiments <- path %>% 
  excel_sheets() %>%
  map_dfr(
    function(sheet) {
      temp = read_excel(sheet, path = path, skip = 8)
      mutate(temp, Year = sheet)
    }
  )

```


## Checks and balances

### Check the top and bottom of the data

Data read in from `xlsx` files often has bits of extra information above *and* below the actual "data". To check that we haven't accidentally imported that we can have a look at the top and bottom of our data set.

```{r}
datatable(advertiments)
```

It looks like we've imported some extra rows that we don't want because they were footer details and some `NA` whole rows. We can remove them.

```{r}
advertiments_clean <- advertiments%>%
  filter(str_detect(`Date Publish To Public Drill`, "Report created") == FALSE | is.na(`Date Publish To Public Drill`) == TRUE) %>%
  filter(is.na(`Position ID Job Title`) == FALSE)
```

Just to check this again. We imported five sheets from the `xlsx` file so `advertiments_clean` should now fave five less rows than `advertisments`. And, the difference in rows is: `r nrow(advertiments) - nrow(advertiments_clean)`!

### Change format

Let's put the variables in a format that we can treat appropriately.

```{r}
advertiments_formatted <- advertiments_clean %>% 
  mutate(`Date Publish To Public Drill` = ymd(`Date Publish To Public Drill`)) %>%
  mutate(`I Workfor SA Min Salary` = as.numeric(`I Workfor SA Min Salary`)) %>%
  mutate(`I Workfor SA Max Salary` = as.numeric(`I Workfor SA Max Salary`))
```

### What are we working with
It would be good to have a look at the data types in each variable to work out if its suitable for what we'll want to do in the analysis.

```{r}
advertiments_formatted %>%
  skim()
```


### Missing data

```{r, fig.align="center"}
advertiments_formatted %>%
  gg_miss_var(show_pct = TRUE, facet = Year) +
  labs(title = str_wrap("Percent of missing data for each variable in `advertisments`", width = 50))
```

It seems that all the variables except `I Workfor SA Part Time Hours` have minimal missing values and none of this changes much over time.

```{r, fig.align="center"}
gg_miss_upset(advertiments_formatted)
```

Its reassuring that `I Workfor SA Min Salary` and `I Workfor SA MAX Salary` are only missing in combination with each other (and sometimes with `I Workfor SA Part Time Hours` as well).

The only note that appears particularly pertinent from these analyses is that `I Workfor SA Part Time Hours` should be treated with caution. We should note that the variables: `Division`, `Position Status`, `Position ID`, `Position ID Job Title`, `I Workfor SA Part Time` and `Year` are all completed with no missing values.

# Analyses

## "Data" jobs

The motivation for getting these data that Owen and Tim talked about was to look at advertisements for "data" jobs to investigate questions such as:

* Are they increasing as a proportion of the advertisements?
* What departments are recruiting them?
* What sort of work are they being anticipated to do?

### Definition caveats

To answer this question we need a definition of "data" jobs.

We can do this by including words and word-parts that signify the sort of job we are interested in. It is worth stating up front that this is necessarily a decision process rather than a data process. That is, the jobs we end up with classified as "data" and "not data" will be so classified because of our subjective *decision* not because of some objective *data*. In addition, this has a signal detection characteristic in that sue to that application of a strict definition, there will be errors both due to some "not data" jobs which end up classified as "data jobs" and some "data jobs" that end up classified as "not data jobs".

### Definition

Regardless, we can set the definition and accept these caveats. Importantly, because the new variable `Defined as a data job` is based on `Position ID Job Title`, there will be no missing values in this new variable. Its worth noting that this step can (and should) be changed as we think more or less terms are applicable.

Its worth noting that there is a variable called `I Workfor SA Job Category` that is fairly complete. Because its not actually complete, its not suitable for basing our definition on. But its useful for a source of inspiration!

Data jobs will be defined as such:

```{r}
data_job_definitions <- c("data", "analy", "information", "intelligence", "statistic", "scient", "research")
```

Then we can append this definition to the data frame:

```{r}
advertiments_defined <- advertiments_formatted %>% 
  mutate(`Defined as a data job` = ifelse(str_detect(str_to_lower(`Position ID Job Title`), 
                                                     paste(data_job_definitions, collapse = "|")
                                                     ), 
         "Data", "Not data"))
```

As a check on our definitions, we should see how often each occur.

```{r}
data_job_type <- advertiments_defined %>%
  select(`Position ID Job Title`) %>%
  mutate(`Is "data"` = ifelse(str_detect(str_to_lower(`Position ID Job Title`), 
                                         data_job_definitions[1]), 1, 0)) %>%
  mutate(`Is "analy"` = ifelse(str_detect(str_to_lower(`Position ID Job Title`), 
                                         data_job_definitions[2]), 1, 0)) %>%
  mutate(`Is "information"` = ifelse(str_detect(str_to_lower(`Position ID Job Title`), 
                                         data_job_definitions[3]), 1, 0)) %>%
  mutate(`Is "intelligence"` = ifelse(str_detect(str_to_lower(`Position ID Job Title`), 
                                         data_job_definitions[4]), 1, 0)) %>%
  mutate(`Is "statistic"` = ifelse(str_detect(str_to_lower(`Position ID Job Title`), 
                                         data_job_definitions[5]), 1, 0)) %>%
  mutate(`Is "scient"` = ifelse(str_detect(str_to_lower(`Position ID Job Title`),
                                         data_job_definitions[6]), 1, 0)) %>%
  mutate(`Is "research"` = ifelse(str_detect(str_to_lower(`Position ID Job Title`),
                                         data_job_definitions[7]), 1, 0))

data_job_type %>%
  select(-`Position ID Job Title`) %>%
  pivot_longer(cols = everything(), names_to = "Data job type", values_to = "Count") %>%
  group_by(`Data job type`) %>%
  summarise(Count = sum(Count)) %>%
  ggplot(aes(x = reorder(`Data job type`, -Count), y = Count, fill = `Data job type`)) + 
  geom_col() + 
  theme(legend.position = "none") + 
  labs(x = "Data job type", title = "Counts of data job types")
  
```

This seems pretty sensible. Lets also check how they join together within a singe `Position ID Job Title`.

```{r}
data_job_type %>%
  select(-`Position ID Job Title`) %>%
  filter_all(any_vars(. == 1)) %>%
  upset(colnames(data_job_type[2:8]))
```

So there were 5 "data scientists". Seems pretty sensible.

## Answers

### Are "data jobs" increasing as a proportion of the advertisments?


```{r, fig.align="center"}
increasing_data <- advertiments_defined %>%
  group_by(`Defined as a data job`, Year) %>%
  count(name = "Number of advertisments") %>%
  group_by(Year) %>%
  mutate(`Proportion within each year`= `Number of advertisments`/sum(`Number of advertisments`))

count_plot <- increasing_data %>%
  ggplot(aes(x = Year, y = `Number of advertisments`, colour = `Defined as a data job`, group = `Defined as a data job`)) + 
  geom_line() + 
  scale_y_log10() + 
  labs(title = "Count of jobs on iworkforsa that  each year by definition")

prop_plot <- increasing_data %>%
  ggplot(aes(x = Year, y = `Proportion within each year`, colour = `Defined as a data job`, group = `Defined as a data job`)) + 
  geom_line() + 
  scale_y_log10() + 
  labs(title = "Proportion of jobs on iworkforsa each year by definition")

count_plot/prop_plot

increasing_data %>%
  filter(`Defined as a data job` == "Data") %>%
  kable() %>%
  kable_styling()
```

This certainly doesn't make it look as though there has been an *explosion* in the proportion of "data" jobs advertised over the last four years. There were `r increasing_data[[4, 3]] - increasing_data[[2,3]]` more "data" jobs in 2020 than in 2018. While this is a `r (increasing_data[[2,3]]/increasing_data[[4, 3]])*100` percent increase in the number of these jobs that were advertised, it is worth noting that this is only an increase from a percent of `r increasing_data[[2,4]] * 100` in 2018 to  `r increasing_data[[4, 4]] * 100` in 2020 of the overall number of jobs that were advertised. That is an increase in just `r (increasing_data[[4, 4]] - increasing_data[[2,4]]) * 100` percent.

### What departments are recruiting them?

```{r, fig.align="center"}
departments_data <- advertiments_defined %>%
  group_by(Division, `Defined as a data job`) %>%
  count(name = "Number of advertisments in division") %>%
  ungroup() %>%
  group_by(Division) %>%
  mutate("Division total" = sum(`Number of advertisments in division`)) %>%
  ungroup() %>%
  mutate("Percent" = (`Number of advertisments in division`/`Division total`)*100)

most_data_departments <- departments_data %>%
  filter(`Defined as a data job` == "Data") %>%
  slice_max(order_by = Percent, n = 12) %>%
  pull(Division)

departments_data  %>%
  filter(Division %in% most_data_departments) %>%
  mutate(Division = factor(Division, levels = most_data_departments, ordered = TRUE)) %>%
  ggplot(aes(x = Division, 
             y = Percent, 
             fill = `Defined as a data job`)) + 
  geom_col(position = "dodge") + 
  labs(title = "Divisions with the greatest proportion of 'data' job advertiments", 
       x = "") + 
  scale_x_discrete(limits=rev) +
  coord_flip()

```

A more comprehensive investigation of these data can be made in the table below:

```{r}
datatable(departments_data)
```

```{r, echo=FALSE}
dhw_count <- departments_data %>% 
  filter(Division == "Department for Health and Wellbeing") %>% 
  filter(`Defined as a data job` == "Data") %>% pull(`Number of advertisments in division`)

dhw_percent <- departments_data %>% 
  filter(Division == "Department for Health and Wellbeing") %>% 
  filter(`Defined as a data job` == "Data") %>% 
  pull(Percent)
```


So, the Department of Health and Wellbeing has the greatest number of "data" job advertisements: `r dhw_count`. But, it also has one of the smallest proportions of data job advertisments: `r dhw_percent`%.

It is worth noting that there are mustiple explanations for the differences in the number of advertiments of "data" jobs between the Divisions.
* Divisions that "data" people like working in may keep their staff for longer and so advertise less
* Some divisions may have recruited more "data" people in an earlier time period
* Some divisions may not be hiring as many "data" people as they think they are

### What sort of work are they being anticipated to do?